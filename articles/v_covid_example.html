<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Simulating Covid-19 Vaccine Data using a Discrete-Time Simulation • simDAG</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Simulating Covid-19 Vaccine Data using a Discrete-Time Simulation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">simDAG</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/v_sim_from_dag.html">Simulating Data from a known DAG</a></li>
    <li><a class="dropdown-item" href="../articles/v_using_formulas.html">Specifying Formulas in a DAG</a></li>
    <li><a class="dropdown-item" href="../articles/v_custom_nodes.html">Specifying Custom Node Types in a DAG</a></li>
    <li><a class="dropdown-item" href="../articles/v_sim_discrete_time.html">Simulating Data using a Discrete-Time Approach</a></li>
    <li><a class="dropdown-item" href="../articles/v_covid_example.html">Simulating Covid-19 Vaccine Data using a Discrete-Time Simulation</a></li>
    <li><a class="dropdown-item" href="../articles/v_cookbook.html">simDAG Cookbook</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/RobinDenz1/siMDAG/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Simulating Covid-19 Vaccine Data using a Discrete-Time Simulation</h1>
                        <h4 data-toc-skip class="author">Robin Denz</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/RobinDenz1/siMDAG/blob/main/vignettes/v_covid_example.Rmd" class="external-link"><code>vignettes/v_covid_example.Rmd</code></a></small>
      <div class="d-none name"><code>v_covid_example.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette contains an in-depth example on how to use the
<code><a href="../reference/sim_discrete_time.html">sim_discrete_time()</a></code> function to generate complex
time-to-event data. Unlike the other vignettes, we will not rely on a
overly simple example here. Instead, our aim is to generate somewhat
realistic data about the Covid-19 pandemic. In particular, we are
interested in generating a longitudinal data set containing Covid-19
infections, vaccines and adverse side effects of those vaccines. The aim
of the real study was to create a data set that is reasonably close to
real data, including measurement problems as described below. This data
generation algorithm was then used to identify a suitable data analysis
strategy for the real data. We only describe a slightly simplified
version of the data generation part here to give a detailed example on
how the <code><a href="../reference/sim_discrete_time.html">sim_discrete_time()</a></code> function may be used
effectively.</p>
<p>Note that the algorithm described here is not completely the same as
the one we originally used, because that would require us to include
confidential data into this vignette, which is sadly impossible.</p>
<p>We also strongly recommend reading the other two vignettes of this
package first.</p>
</div>
<div class="section level2">
<h2 id="how-to-get-started">How to get started<a class="anchor" aria-label="anchor" href="#how-to-get-started"></a>
</h2>
<p>Simulating data that is reasonably close to a complex real system is
not a trivial task, even when using this package. Dividing the big task
of obtaining a valid data generation model into multiple sub-tasks is a
great first step in the right direction. We suggest following the 7
steps below:</p>
<div class="section level3">
<h3 id="formulate-the-goal-of-your-research-project-in-a-detailed-fashion-">
<strong>1.)</strong> Formulate the goal of your research project in
a detailed fashion.<a class="anchor" aria-label="anchor" href="#formulate-the-goal-of-your-research-project-in-a-detailed-fashion-"></a>
</h3>
<p>If you haven’t done this yet, now is the time. Try to make your goal
as explicit as possible. This will help you in deciding which aspects of
the system are important to you and which can be safely ignored.</p>
</div>
<div class="section level3">
<h3 id="build-a-theoretical-model-of-the-system-you-want-to-simulate-">
<strong>2.)</strong> Build a theoretical model of the system you
want to simulate.<a class="anchor" aria-label="anchor" href="#build-a-theoretical-model-of-the-system-you-want-to-simulate-"></a>
</h3>
<p>This entails reading up on relevant literature and writing down any
assumptions you may already have about the system. Perhaps (and usually
most likely) other researchers have tried to build a simulation model
for the same system (or a very similar system). A great way to encode
your causal assumptions of the system is time-dependent DAG, as
discussed in the other vignettes.</p>
</div>
<div class="section level3">
<h3 id="identify-the-parts-of-the-system-that-you-are-most-interested-in-">
<strong>3.)</strong> Identify the parts of the system that you are
most interested in.<a class="anchor" aria-label="anchor" href="#identify-the-parts-of-the-system-that-you-are-most-interested-in-"></a>
</h3>
<p>Real systems are incredibly complex. Any simulation will have to make
some simplifying assumptions. After building a moderately detailed
version of the theoretical model, you will have to decide which aspects
are of interest to your research project and which aren’t.</p>
</div>
<div class="section level3">
<h3 id="obtain-and-analyze-real-data-">
<strong>4.)</strong> Obtain and analyze real data.<a class="anchor" aria-label="anchor" href="#obtain-and-analyze-real-data-"></a>
</h3>
<p>If the simulated data should correspond to real data, it is crucial
to base the input of the model on actual empirical data. Using the
empirical data, you may be able to derive appropriate distributions for
the root nodes and appropriate functional forms of the relationship
between the considered variables.</p>
</div>
<div class="section level3">
<h3 id="simulate-data-for-t-0-if-needed-">
<strong>5.)</strong> Simulate data for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">t = 0</annotation></semantics></math>
(if needed).<a class="anchor" aria-label="anchor" href="#simulate-data-for-t-0-if-needed-"></a>
</h3>
<p>After having specified suitable distributions and relationships,
generate the initial data used in the simulation process. It is
important to check this data thoroughly, as it will be used as a basis
for all subsequent steps of the simulation. The
<code><a href="../reference/sim_from_DAG.html">sim_from_dag()</a></code> function might be very helpful for this
step.</p>
</div>
<div class="section level3">
<h3 id="write-functions-for-each-time-varying-node-one-at-a-time-">
<strong>6.)</strong> Write functions for each time-varying node, one
at a time.<a class="anchor" aria-label="anchor" href="#write-functions-for-each-time-varying-node-one-at-a-time-"></a>
</h3>
<p>Each time-varying node requires a user written function that
transforms the data at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
to the data at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">t + 1</annotation></semantics></math>.
It might be helpful to add one time-varying node at a time and
proceeding to step <strong>7.)</strong> before adding other variables,
if possible.</p>
</div>
<div class="section level3">
<h3 id="inspect-the-resulting-data-for-inconsistencies-">
<strong>7.)</strong> Inspect the resulting data for
inconsistencies.<a class="anchor" aria-label="anchor" href="#inspect-the-resulting-data-for-inconsistencies-"></a>
</h3>
<p>Validating your simulation code is important to ensure that no
mistakes slipped through. This may be done by fitting models relying on
your modeling assumptions to the generated data and checking whether
those models produce the expected results.</p>
</div>
</div>
<div class="section level2">
<h2 id="our-research-goal-and-the-theoretical-model">Our research goal and the theoretical model<a class="anchor" aria-label="anchor" href="#our-research-goal-and-the-theoretical-model"></a>
</h2>
<p>Since this vignette is mostly concerned with the practical
implementation of the discrete-time simulation approach using this
R-package, we will not spend too much time on the first 4 steps of the
process mentioned in the previous section. We only briefly present the
most important points.</p>
<div class="section level3">
<h3 id="research-goal">Research goal<a class="anchor" aria-label="anchor" href="#research-goal"></a>
</h3>
<p>Our actual research goal was to identify a suitable data analysis
strategy for the assessment of Covid-19 vaccine side-effects for a
particular real-life data set. To do this we decided to simulate data
that is as close to the real data as possible. Using this data we could
then try out different analysis strategies and see which one performed
adequately. The goal for this vignette is to use parts of this model to
showcase the capabilities of the <code>simDAG</code> package. More
information on the actual simulation can be found in the first related
publication (Denz et al. 2023).</p>
</div>
<div class="section level3">
<h3 id="theoretical-model">Theoretical model<a class="anchor" aria-label="anchor" href="#theoretical-model"></a>
</h3>
<p>There is a seemingly endless amount of literature describing models
for the Covid-19 pandemic and the associated Covid-19 vaccines. Trying
to include all relevant aspects would be an unfeasible task. After
deliberating on this literature we decided to include only a few key
variables. To make this vignette readable we further limited the
variables to only include the most essential:</p>
<ul>
<li>
<code>vaccination</code>: The time at which the person received the
first vaccine.</li>
<li>
<code>covid</code>: Whether a Covid-19 infection occurred.</li>
<li>
<code>sickness</code>: Whether the person has developed the sickness
of interest.</li>
</ul>
<p>We assume that these three variables vary over time and cause each
other.</p>
</div>
</div>
<div class="section level2">
<h2 id="implementing-the-model">Implementing the model<a class="anchor" aria-label="anchor" href="#implementing-the-model"></a>
</h2>
<p>Instead of diving in deep from the start and trying to include all
relevant variables with all relevant relationships at once, it is often
better to build a very simplified version first and to start adding more
and more stuff to it as we continue.</p>
<div class="section level3">
<h3 id="part-1-adding-vaccination-covid-and-sickness">Part 1: Adding vaccination, covid and sickness<a class="anchor" aria-label="anchor" href="#part-1-adding-vaccination-covid-and-sickness"></a>
</h3>
<p>The most important variables for us are the <code>vaccination</code>,
the <code>covid</code>-19 infection and the <code>sickness</code>. All
of these are variables that have a certain probability of occurrence at
each point in time. Once they occur, they last for some duration
(e.g. someone being sick for two weeks or something similar). After the
event is over, there is usually some duration where the person is
“immune” to receiving the event again. This is a perfect case for using
a time-dependent node of type <code>"time_to_event"</code>.</p>
<p>We start out modeling every one of these variables as completely
independent of each other using the following DAG:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RobinDenz1/simDAG" class="external-link">simDAG</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">dag</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/empty_dag.html">empty_dag</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node_td</a></span><span class="op">(</span><span class="st">"vaccination"</span>, type<span class="op">=</span><span class="st">"time_to_event"</span>, prob_fun<span class="op">=</span><span class="fl">0.001</span>,</span>
<span>          event_duration<span class="op">=</span><span class="fl">21</span>, immunity_duration<span class="op">=</span><span class="cn">Inf</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node_td</a></span><span class="op">(</span><span class="st">"covid"</span>, type<span class="op">=</span><span class="st">"time_to_event"</span>, prob_fun<span class="op">=</span><span class="fl">0.001</span>, event_duration<span class="op">=</span><span class="fl">30</span>,</span>
<span>          immunity_duration<span class="op">=</span><span class="fl">80</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node_td</a></span><span class="op">(</span><span class="st">"sickness"</span>, type<span class="op">=</span><span class="st">"time_to_event"</span>, prob_fun<span class="op">=</span><span class="fl">0.0001</span>,</span>
<span>          event_duration<span class="op">=</span><span class="fl">2</span>, immunity_duration<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>In the DAG above, we supplied a constant value to each of the
<code>prob_fun</code> arguments, indicating that regardless of time and
other variables, each event has a constant probability of occurring on
each day. We set the <code>event_duration</code> of
<code>vaccination</code> to 21, because we want to model the time after
vaccination in which the risk for the adverse side-effect (e.g. the
<code>sickness</code>) is higher than usual later on. By setting the
<code>immunity_duration</code> of the <code>vaccination</code> to
<code>Inf</code>, we are currently only allowing the person to get one
vaccination over the entire time. The <code>sickness</code> is allowed
to occur again directly after it was over.</p>
</div>
<div class="section level3">
<h3 id="part-2-adding-adverse-effects-of-vaccination-and-covid">Part 2: Adding adverse effects of vaccination and covid<a class="anchor" aria-label="anchor" href="#part-2-adding-adverse-effects-of-vaccination-and-covid"></a>
</h3>
<p>We can make this data-generation process a little more interesting by
making both the <code>vaccination</code> and <code>covid</code> have an
effect on the probability of developing the sickness. We will do this by
simply raising the probability of occurrence of the
<code>sickness</code> by a constant factor whenever either a
<code>covid</code> or <code>vaccination</code> event is currently
happening. This can be done by formulating an appropriate
<code>prob_fun</code> for the <code>sickness</code> node:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prob_sickness</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">rr_covid</span>, <span class="va">rr_vacc</span>, <span class="va">base_p</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># multiply base probability by relevant RRs</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">base_p</span> <span class="op">*</span> <span class="va">rr_vacc</span><span class="op">^</span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">vaccination_event</span><span class="op">)</span> <span class="op">*</span> <span class="va">rr_covid</span><span class="op">^</span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">covid_event</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This works because any number to an exponent of 1 is itself, while
any number to an exponent of 0 is one. The
<code>vaccination_event</code> and <code>covid_event</code> columns are
always either <code>TRUE</code> (when an event is currently happening)
or <code>FALSE</code> (when no event is currently happening), which are
interpreted as 1 and 0 by R. Let’s update our DAG:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dag</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/empty_dag.html">empty_dag</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node_td</a></span><span class="op">(</span><span class="st">"vaccination"</span>, type<span class="op">=</span><span class="st">"time_to_event"</span>, prob_fun<span class="op">=</span><span class="fl">0.001</span>,</span>
<span>          event_duration<span class="op">=</span><span class="fl">21</span>, immunity_duration<span class="op">=</span><span class="cn">Inf</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node_td</a></span><span class="op">(</span><span class="st">"covid"</span>, type<span class="op">=</span><span class="st">"time_to_event"</span>, prob_fun<span class="op">=</span><span class="fl">0.001</span>, event_duration<span class="op">=</span><span class="fl">30</span>,</span>
<span>          immunity_duration<span class="op">=</span><span class="fl">80</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node_td</a></span><span class="op">(</span><span class="st">"sickness"</span>, type<span class="op">=</span><span class="st">"time_to_event"</span>, prob_fun<span class="op">=</span><span class="va">prob_sickness</span>,</span>
<span>          parents<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"vaccination_event"</span>, <span class="st">"covid_event"</span><span class="op">)</span>,</span>
<span>          base_p<span class="op">=</span><span class="fl">0.0001</span>, rr_covid<span class="op">=</span><span class="fl">3.5</span>, rr_vacc<span class="op">=</span><span class="fl">3.24</span>,</span>
<span>          event_duration<span class="op">=</span><span class="fl">2</span>, immunity_duration<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>Instead of passing a constant value to the <code>prob_fun</code>
argument, we are now passing it the previously defined function. Because
our function has <code>base_p</code>, <code>rr_covid</code> and
<code>rr_vacc</code> as arguments without defaults, we have to specify
those in the <code>node_td</code> call as well. We keep the original
<code>base_p</code>, and set the relative risks to 3.5 and 3.24
respectively. Additionally, we have to set both the
<code>vaccination_event</code> and the <code>covid_event</code> columns
as <code>parents</code> now, because they are used in the
<code>prob_sickness</code> function.</p>
</div>
<div class="section level3">
<h3 id="part-3-making-the-vaccine-useful">Part 3: Making the vaccine useful<a class="anchor" aria-label="anchor" href="#part-3-making-the-vaccine-useful"></a>
</h3>
<p>So far we assumed that the <code>covid</code> infection probability
is unaffected by whether the person received the vaccine or not. We will
now change this by implementing a time-window after receiving the
vaccine in which the person cannot develop a <code>covid</code>
infection. Again, this can be done by defining an appropriate
<code>prob_fun</code> function, this time for the <code>covid</code>
node:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prob_covid</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">base_p</span>, <span class="va">vacc_duration</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fifelse.html" class="external-link">fifelse</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">vaccination_time_since_last</span> <span class="op">&lt;</span> <span class="va">vacc_duration</span>,</span>
<span>               <span class="fl">0</span>, <span class="va">base_p</span>, na<span class="op">=</span><span class="va">base_p</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>In this function we use the column
<code>vaccination_time_since_last</code>, which is a column that can
optionally be created in time-to-event nodes by setting
<code>time_since_last</code> to <code>TRUE</code>. So let’s again update
our DAG accordingly:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dag</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/empty_dag.html">empty_dag</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node_td</a></span><span class="op">(</span><span class="st">"vaccination"</span>, type<span class="op">=</span><span class="st">"time_to_event"</span>, prob_fun<span class="op">=</span><span class="fl">0.001</span>,</span>
<span>          event_duration<span class="op">=</span><span class="fl">21</span>, immunity_duration<span class="op">=</span><span class="cn">Inf</span>,</span>
<span>          time_since_last<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node_td</a></span><span class="op">(</span><span class="st">"covid"</span>, type<span class="op">=</span><span class="st">"time_to_event"</span>, prob_fun<span class="op">=</span><span class="va">prob_covid</span>,</span>
<span>          parents<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"vaccination_time_since_last"</span><span class="op">)</span>,</span>
<span>          base_p<span class="op">=</span><span class="fl">0.001</span>, vacc_duration<span class="op">=</span><span class="fl">80</span>, event_duration<span class="op">=</span><span class="fl">30</span>,</span>
<span>          immunity_duration<span class="op">=</span><span class="fl">80</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node_td</a></span><span class="op">(</span><span class="st">"sickness"</span>, type<span class="op">=</span><span class="st">"time_to_event"</span>, prob_fun<span class="op">=</span><span class="va">prob_sickness</span>,</span>
<span>          parents<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"vaccination_event"</span>, <span class="st">"covid_event"</span><span class="op">)</span>,</span>
<span>          base_p<span class="op">=</span><span class="fl">0.0001</span>, rr_covid<span class="op">=</span><span class="fl">3.5</span>, rr_vacc<span class="op">=</span><span class="fl">3.24</span>,</span>
<span>          event_duration<span class="op">=</span><span class="fl">2</span>, immunity_duration<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>Instead of just updating the <code>parents</code> and
<code>prob_fun</code> arguments of the <code>covid</code> node, we now
also had to set the <code>time_since_last</code> argument of the
<code>vaccination</code> node to <code>TRUE</code> as well to get the
required additional column. Our data-generation algorithm is getting
better now. But there is still a lot we can do.</p>
</div>
<div class="section level3">
<h3 id="part-4-sick-people-dont-get-vaccinated">Part 4: Sick people don’t get vaccinated<a class="anchor" aria-label="anchor" href="#part-4-sick-people-dont-get-vaccinated"></a>
</h3>
<p>In reality, very little people who were currently experiencing a
Covid-19 infection went and got the vaccine. In fact, this is absolutely
discouraged by doctors world-wide. To add this circumstance to the
model, we once again simply have to update the probability of receiving
a vaccination, by defining an appropriate <code>prob_fun</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prob_vaccination</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">base_p</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fifelse.html" class="external-link">fifelse</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">covid_event</span>, <span class="fl">0</span>, <span class="va">base_p</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Using this function, the probability of getting vaccinated for any
individual that is currently experiencing a <code>covid</code> infection
is 0. Let’s update our DAG one more time to include these changes:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dag</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/empty_dag.html">empty_dag</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node_td</a></span><span class="op">(</span><span class="st">"vaccination"</span>, type<span class="op">=</span><span class="st">"time_to_event"</span>,</span>
<span>          prob_fun<span class="op">=</span><span class="va">prob_vaccination</span>,</span>
<span>          parents<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"covid_event"</span><span class="op">)</span>, base_p<span class="op">=</span><span class="fl">0.001</span>,</span>
<span>          event_duration<span class="op">=</span><span class="fl">21</span>, immunity_duration<span class="op">=</span><span class="cn">Inf</span>,</span>
<span>          time_since_last<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node_td</a></span><span class="op">(</span><span class="st">"covid"</span>, type<span class="op">=</span><span class="st">"time_to_event"</span>, prob_fun<span class="op">=</span><span class="va">prob_covid</span>,</span>
<span>          parents<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"vaccination_time_since_last"</span><span class="op">)</span>,</span>
<span>          base_p<span class="op">=</span><span class="fl">0.001</span>, vacc_duration<span class="op">=</span><span class="fl">80</span>, event_duration<span class="op">=</span><span class="fl">30</span>,</span>
<span>          immunity_duration<span class="op">=</span><span class="fl">80</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node_td</a></span><span class="op">(</span><span class="st">"sickness"</span>, type<span class="op">=</span><span class="st">"time_to_event"</span>, prob_fun<span class="op">=</span><span class="va">prob_sickness</span>,</span>
<span>          parents<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"vaccination_event"</span>, <span class="st">"covid_event"</span><span class="op">)</span>,</span>
<span>          base_p<span class="op">=</span><span class="fl">0.0001</span>, rr_covid<span class="op">=</span><span class="fl">3.5</span>, rr_vacc<span class="op">=</span><span class="fl">3.24</span>,</span>
<span>          event_duration<span class="op">=</span><span class="fl">2</span>, immunity_duration<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>Again we simply changed the <code>prob_fun</code> argument and added
the correct <code>parents</code> to the appropriate node. Our final
“DAG” looks like this:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dag</span>, mark_td_nodes<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required namespace: ggforce</span></span></code></pre></div>
<p><img src="v_covid_example_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
<p>Note that in this plot it doesn’t look like a classic DAG anymore,
because it has a bi-directional arrow between <code>covid</code> and
<code>vaccination</code> due to the time-dependent nature of their
relationship.</p>
</div>
<div class="section level3">
<h3 id="generating-data-using-the-final-model">Generating Data using the final model<a class="anchor" aria-label="anchor" href="#generating-data-using-the-final-model"></a>
</h3>
<p>Suppose we are now pleased with the complexity of our data-generation
algorithm and want to simulate data from it. We can do this by simply
calling the <code><a href="../reference/sim_discrete_time.html">sim_discrete_time()</a></code> function on the specified
DAG:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_discrete_time.html">sim_discrete_time</a></span><span class="op">(</span><span class="va">dag</span>, n_sim<span class="op">=</span><span class="fl">1000</span>, max_t<span class="op">=</span><span class="fl">800</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span></span>
<span><span class="co">#&gt; A simDT object with:</span></span>
<span><span class="co">#&gt;   -  1000  observations</span></span>
<span><span class="co">#&gt;   -  800  distinct points in time</span></span>
<span><span class="co">#&gt;   -  3  time-varying variables in total</span></span>
<span><span class="co">#&gt;   -  3  time_to_event nodes</span></span>
<span><span class="co">#&gt;   -  0  competing_events nodes</span></span>
<span><span class="co">#&gt; Only the last state of the simulation was saved.</span></span></code></pre></div>
<p>For exemplary purposes, we kind of arbitrarily used 1000 individuals
and let the simulation run for 800 days. By calling the
<code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> method, we get a concise overview over the process
we simulated:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sim</span>, box_text_size<span class="op">=</span><span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p><img src="v_covid_example_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
<p>A more useful output of the resulting data can be obtained using the
<code><a href="../reference/sim2data.html">sim2data()</a></code> function. For example, we could transform the
output to the start-stop format:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sim2data.html">sim2data</a></span><span class="op">(</span><span class="va">sim</span>, to<span class="op">=</span><span class="st">"start_stop"</span><span class="op">)</span></span>
<span><span class="co">#&gt;         .id start  stop vaccination  covid sickness</span></span>
<span><span class="co">#&gt;       &lt;int&gt; &lt;int&gt; &lt;num&gt;      &lt;lgcl&gt; &lt;lgcl&gt;   &lt;lgcl&gt;</span></span>
<span><span class="co">#&gt;    1:     1     1   178       FALSE  FALSE    FALSE</span></span>
<span><span class="co">#&gt;    2:     1   179   199        TRUE  FALSE    FALSE</span></span>
<span><span class="co">#&gt;    3:     1   200   800       FALSE  FALSE    FALSE</span></span>
<span><span class="co">#&gt;    4:     2     1   501       FALSE  FALSE    FALSE</span></span>
<span><span class="co">#&gt;    5:     2   502   531       FALSE   TRUE    FALSE</span></span>
<span><span class="co">#&gt;   ---                                              </span></span>
<span><span class="co">#&gt; 3466:  1000     1    47       FALSE  FALSE    FALSE</span></span>
<span><span class="co">#&gt; 3467:  1000    48    49       FALSE  FALSE     TRUE</span></span>
<span><span class="co">#&gt; 3468:  1000    50   131       FALSE  FALSE    FALSE</span></span>
<span><span class="co">#&gt; 3469:  1000   132   152        TRUE  FALSE    FALSE</span></span>
<span><span class="co">#&gt; 3470:  1000   153   800       FALSE  FALSE    FALSE</span></span></code></pre></div>
<p>As can be seen, we managed to implement a fairly complex
data-generation mechanism using only a few small function definitions
and a few lines of code, allowing us to generate a complex dataset with
three interdependent time-varying variables with only minimal
effort.</p>
</div>
<div class="section level3">
<h3 id="going-even-further">Going even further<a class="anchor" aria-label="anchor" href="#going-even-further"></a>
</h3>
<p>There is no need to stop here. We could make this simulation model
even more complex by implementing any of the following things:</p>
<ul>
<li>Adding time-dependent base-probabilities for
<code>vaccination</code>, <code>covid</code> and
<code>sickness</code>
</li>
<li>Adding different kinds of <code>vaccination</code>s, perhaps with
different effects on <code>covid</code> and/or
<code>sickness</code>
</li>
<li>Adding time-fixed variables such as <code>sex</code> which have an
effect on any of the other variables</li>
<li>Allowing multiple vaccinations</li>
<li>Changing the constant raising of the probabilities in the form of a
relative risk to a more realistic non-linear time-dependent relative
risk</li>
</ul>
<p>There are of course many more possible extensions, all of which can
be implemented by augmenting the respective <code>prob_fun</code>
arguments and updating the <code>dag</code> accordingly. In fact, in the
real monte-carlo simulation we conducted, that is exactly what we did.
We used empirical data to model time-dependent base-probabilities and
more. How much complexity you really need is completely up to you. We
hope that the <code>simDAG</code> package can help you with whatever you
need.</p>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Banks, Jerry, John S. Carson II, Barry L. Nelson, and David M. Nicol
(2014). Discrete-Event System Simulation. Vol. 5. Edinburgh Gate:
Pearson Education Limited.</p>
<p>Denz, Robin, Katharina Meiszl, Peter Ihle, Doris F. Oberle, Ursula
Drechsel-Bäuerle, Katrin Scholz, Ingo Meyer and Nina Timmesfeld (2023).
“Impact of Record-Linkage Errors in Covid-19 Vaccine-Safety Analyses
using German Health-Care Data: A Simulation Study”. In:
arXiv:2310.15016</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Robin Denz, Katharina Meiszl.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
