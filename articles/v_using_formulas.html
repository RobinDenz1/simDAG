<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Specifying Formulas in a DAG • simDAG</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Specifying Formulas in a DAG">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">simDAG</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/simDAG.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/v_sim_from_dag.html">Simulating Data from a known DAG</a></li>
    <li><a class="dropdown-item" href="../articles/v_using_formulas.html">Specifying Formulas in a DAG</a></li>
    <li><a class="dropdown-item" href="../articles/v_custom_nodes.html">Specifying Custom Node Types in a DAG</a></li>
    <li><a class="dropdown-item" href="../articles/v_sim_discrete_time.html">Simulating Data using a Discrete-Time Approach</a></li>
    <li><a class="dropdown-item" href="../articles/v_covid_example.html">Simulating Covid-19 Vaccine Data using a Discrete-Time Simulation</a></li>
    <li><a class="dropdown-item" href="../articles/v_sim_networks.html">Simulating Data from a DAG with Network Dependencies</a></li>
    <li><a class="dropdown-item" href="../articles/v_cookbook.html">simDAG Cookbook</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/RobinDenz1/siMDAG/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Specifying Formulas in a DAG</h1>
                        <h4 data-toc-skip class="author">Robin Denz</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/RobinDenz1/siMDAG/blob/main/vignettes/v_using_formulas.Rmd" class="external-link"><code>vignettes/v_using_formulas.Rmd</code></a></small>
      <div class="d-none name"><code>v_using_formulas.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this small vignette, we give more detailed examples on how best to
use the <code>formula</code> argument in the <code><a href="../reference/node.html">node()</a></code> and
<code><a href="../reference/node.html">node_td()</a></code> functions. This argument allows users to directly
specify the full structural equation that should be used to generate the
respective node in a clear and easy way, that does not directly rely on
the <code>parents</code>, <code>betas</code> and associated arguments.
Note that the <code>formula</code> argument may only be used with
certain node types, as mentioned in the documentation.</p>
</div>
<div class="section level2">
<h2 id="a-simple-example">A simple example<a class="anchor" aria-label="anchor" href="#a-simple-example"></a>
</h2>
<p>We will start with a very simple example. Suppose we want to generate
some data from a simple DAG with no time-varying variables. Consider the
following DAG:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RobinDenz1/simDAG" class="external-link">simDAG</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">dag</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/empty_dag.html">empty_dag</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="st">"A"</span>, type<span class="op">=</span><span class="st">"rnorm"</span>, mean<span class="op">=</span><span class="fl">0</span>, sd<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="st">"B"</span>, type<span class="op">=</span><span class="st">"rbernoulli"</span>, p<span class="op">=</span><span class="fl">0.5</span>, output<span class="op">=</span><span class="st">"numeric"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="st">"C"</span>, type<span class="op">=</span><span class="st">"rcategorical"</span>, probs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.2</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>       output<span class="op">=</span><span class="st">"factor"</span>, labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"low"</span>, <span class="st">"medium"</span>, <span class="st">"high"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This DAG contains only three root nodes of different types.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math>
is normally distributed,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math>
is Bernoulli distributed and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math>
is a simple categorical variable with the levels “low”, “medium” and
“high”. If we generate data from this DAG alone, it would look like
this:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">23143</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_from_DAG.html">sim_from_dag</a></span><span class="op">(</span><span class="va">dag</span>, n_sim<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span><span class="co">#&gt;             A     B      C</span></span>
<span><span class="co">#&gt;         &lt;num&gt; &lt;num&gt; &lt;fctr&gt;</span></span>
<span><span class="co">#&gt; 1: -0.8041685     0    low</span></span>
<span><span class="co">#&gt; 2:  1.3390885     0 medium</span></span>
<span><span class="co">#&gt; 3:  0.9455804     0   high</span></span>
<span><span class="co">#&gt; 4: -2.3437852     1    low</span></span>
<span><span class="co">#&gt; 5: -0.9045554     1 medium</span></span>
<span><span class="co">#&gt; 6:  0.8532361     1 medium</span></span></code></pre></div>
<p>Suppose we now want to generate an additional child node called
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>
which should be based on a linear regression model of the form:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mo>∼</mo><mo>−</mo><mn>8</mn><mo>+</mo><mi>A</mi><mo>⋅</mo><mn>0.4</mn><mo>+</mo><mi>B</mi><mo>⋅</mo><mo>−</mo><mn>2</mn><mo>+</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1.5</mn><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex">D \sim -8 + A \cdot 0.4 + B \cdot -2 + N(0, 1.5).</annotation></semantics></math></p>
<p>We could do this using the <code><a href="../reference/node.html">node()</a></code> function, by supplying
appropriate values to the <code>parents</code>, <code>betas</code>,
<code>intercept</code> and <code>error</code> arguments. The following
code could be used:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dag_without_formula</span> <span class="op">&lt;-</span> <span class="va">dag</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="st">"D"</span>, type<span class="op">=</span><span class="st">"gaussian"</span>, parents<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>, betas<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="op">-</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>       intercept<span class="op">=</span><span class="op">-</span><span class="fl">8</span>, error<span class="op">=</span><span class="fl">1.5</span><span class="op">)</span></span></code></pre></div>
<p>This does work just fine, but it may be a little cumbersome to
specify the DAG in this way. Since we want to use a linear regression
model, we could instead use the <code>formula</code> argument like
this:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dag_with_formula</span> <span class="op">&lt;-</span> <span class="va">dag</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="st">"D"</span>, type<span class="op">=</span><span class="st">"gaussian"</span>, formula<span class="op">=</span> <span class="op">~</span> <span class="op">-</span><span class="fl">8</span> <span class="op">+</span> <span class="va">A</span><span class="op">*</span><span class="fl">0.4</span> <span class="op">+</span> <span class="va">B</span><span class="op">*</span><span class="op">-</span><span class="fl">2</span>, error<span class="op">=</span><span class="fl">1.5</span><span class="op">)</span></span></code></pre></div>
<p>Given the same random number generator seed, the same output will be
produced from both DAGs, as shown below:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">34</span><span class="op">)</span></span>
<span><span class="va">dat1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_from_DAG.html">sim_from_dag</a></span><span class="op">(</span><span class="va">dag_without_formula</span>, n_sim<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">34</span><span class="op">)</span></span>
<span><span class="va">dat2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_from_DAG.html">sim_from_dag</a></span><span class="op">(</span><span class="va">dag_with_formula</span>, n_sim<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">dat1</span>, <span class="va">dat2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>Formulas should always start with a <code>~</code> sign and have
nothing else on the left hand side. All parts of the formula should be
connected by <code>+</code> signs, never <code>-</code> signs. The name
of the respective variable should always be connected to the associated
coefficient by a <code>*</code> sign. It does not matter whether the
name of the term or the coefficient go first, but it has to be
consistent in a formula. For example, <code>~ 1 + A*2 + B*3</code>
works, and <code>~ 1 + 2*A + 3*B</code> also works, but
<code>~ 1 + 2*A + B*2</code> will produce an error. The formula may also
be supplied as a string and will produce the same output.</p>
<p>Apart from being easier to read, this also allows the user a lot more
options. Through the use of formulas it is possible to specify nodes
that have categorical parents. It is also possible to include any order
of interaction effects and cubic terms using formulas, as shown
below.</p>
</div>
<div class="section level2">
<h2 id="using-a-categorical-parent-variable">Using a Categorical Parent Variable<a class="anchor" aria-label="anchor" href="#using-a-categorical-parent-variable"></a>
</h2>
<p>Suppose that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>
should additionally depend on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math>,
a categorical variable. For example, suppose this is the regression
model we want to generate data from:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mo>∼</mo><mo>−</mo><mn>8</mn><mo>+</mo><mi>A</mi><mo>⋅</mo><mn>0.4</mn><mo>+</mo><mi>B</mi><mo>⋅</mo><mo>−</mo><mn>2</mn><mo>+</mo><mi>C</mi><mi>m</mi><mi>e</mi><mi>d</mi><mi>i</mi><mi>u</mi><mi>m</mi><mo>⋅</mo><mo>−</mo><mn>1</mn><mo>+</mo><mi>C</mi><mi>h</mi><mi>i</mi><mi>g</mi><mi>h</mi><mo>⋅</mo><mo>−</mo><mn>3</mn><mo>+</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1.5</mn><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex">D \sim -8 + A \cdot 0.4 + B \cdot -2 + Cmedium \cdot -1 + Chigh \cdot -3 + N(0, 1.5).</annotation></semantics></math></p>
<p>In this model, the “low” category is used as a reference category. If
this is what we want to do, using the simple <code>parents</code>,
<code>betas</code>, <code>intercept</code> approach no longer works. We
have to use a formula. Fortunately, this is really simple to do using
the following code:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dag2</span> <span class="op">&lt;-</span> <span class="va">dag</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="st">"D"</span>, type<span class="op">=</span><span class="st">"gaussian"</span>, error<span class="op">=</span><span class="fl">1.5</span>,</span>
<span>       formula<span class="op">=</span><span class="op">~</span> <span class="op">-</span><span class="fl">8</span> <span class="op">+</span> <span class="va">A</span><span class="op">*</span><span class="fl">0.4</span> <span class="op">+</span> <span class="va">B</span><span class="op">*</span><span class="op">-</span><span class="fl">2</span> <span class="op">+</span> <span class="va">Cmedium</span><span class="op">*</span><span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="va">Chigh</span><span class="op">*</span><span class="op">-</span><span class="fl">3</span>,</span>
<span>       parents<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Essentially, all we have to do is use the name of the categorical
variable immediately followed by the category name. Note that if a
different reference category should be used, the user needs to re-define
the factor levels of the categorical variable accordingly first.</p>
<p>Note that we also defined the <code>parents</code> argument in this
case. This is not strictly necessary to generate the data in this case,
but it is recommended whenever categorical variables are used in a
<code>formula</code> for two reasons:</p>
<ul>
<li>
<strong>1.)</strong> If <code>parents</code> is not specified, the
<code><a href="../reference/sim_from_DAG.html">sim_from_dag()</a></code> function will not know that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math>
is a parent of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>.
If <code>sort_dag=TRUE</code> and/or the nodes are not specified in a
correctly topologically sorted order, this may lead to errors when
trying to generate the data.</li>
<li>
<strong>2.)</strong> If <code>parents</code> is not specified, other
functions that take DAG objects as input (such as the
<code><a href="../reference/plot.DAG.html">plot.DAG()</a></code> function) may produce incorrect output, because
they won’t know that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math>
is a parent of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>.</li>
</ul>
</div>
<div class="section level2">
<h2 id="using-interaction-effects">Using Interaction Effects<a class="anchor" aria-label="anchor" href="#using-interaction-effects"></a>
</h2>
<p>Interactions of any sort may also be added to the DAG. Suppose we
want to generate data from the following regression model:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mo>∼</mo><mo>−</mo><mn>8</mn><mo>+</mo><mi>A</mi><mo>⋅</mo><mn>0.4</mn><mo>+</mo><mi>B</mi><mo>⋅</mo><mo>−</mo><mn>2</mn><mo>+</mo><mi>A</mi><mo>*</mo><mi>B</mi><mo>⋅</mo><mo>−</mo><mn>5</mn><mo>+</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1.5</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mrow><annotation encoding="application/x-tex">D \sim -8 + A \cdot 0.4 + B \cdot -2 + A*B \cdot -5 + N(0, 1.5),</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>*</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">A*B</annotation></semantics></math>
indicates the interaction between
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math>.
This can be specified in the <code>formula</code> argument using the
<code>:</code> sign:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dag3</span> <span class="op">&lt;-</span> <span class="va">dag</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="st">"D"</span>, type<span class="op">=</span><span class="st">"gaussian"</span>, formula<span class="op">=</span> <span class="op">~</span> <span class="op">-</span><span class="fl">8</span> <span class="op">+</span> <span class="va">A</span><span class="op">*</span><span class="fl">0.4</span> <span class="op">+</span> <span class="va">B</span><span class="op">*</span><span class="op">-</span><span class="fl">2</span> <span class="op">+</span> <span class="va">A</span><span class="op">:</span><span class="va">B</span><span class="op">*</span><span class="op">-</span><span class="fl">5</span>, error<span class="op">=</span><span class="fl">1.5</span><span class="op">)</span></span></code></pre></div>
<p>Since both
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math>
are coded as numeric variables here, this works fine. If we instead want
to include an interaction which includes a categorical variable, we
again have to use the name with the respective category appended to it.
For example, the following DAG includes an interaction between
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dag4</span> <span class="op">&lt;-</span> <span class="va">dag</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="st">"D"</span>, type<span class="op">=</span><span class="st">"gaussian"</span>, error<span class="op">=</span><span class="fl">1.5</span>,</span>
<span>       formula<span class="op">=</span><span class="op">~</span> <span class="op">-</span><span class="fl">8</span> <span class="op">+</span> <span class="va">A</span><span class="op">*</span><span class="fl">0.4</span> <span class="op">+</span> <span class="va">B</span><span class="op">*</span><span class="op">-</span><span class="fl">2</span> <span class="op">+</span> <span class="va">Cmedium</span><span class="op">*</span><span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="va">Chigh</span><span class="op">*</span><span class="op">-</span><span class="fl">3</span> <span class="op">+</span> <span class="va">A</span><span class="op">:</span><span class="va">Cmedium</span><span class="op">*</span><span class="fl">0.3</span> <span class="op">+</span> </span>
<span>         <span class="va">A</span><span class="op">:</span><span class="va">Chigh</span><span class="op">*</span><span class="fl">10</span>,</span>
<span>       parents<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Higher order interactions may be specified in exactly the same way,
just using more <code>:</code> symbols. It may not always be obvious in
which order the variables for the interaction need to be specified. If
the “wrong” order was used, the <code><a href="../reference/sim_from_DAG.html">sim_from_dag()</a></code> function
will return a helpful error message explaining which ones should be used
instead. For example, if we had used “Cmedium:A” instead of “A:Cmedium”,
this would not work because internally only the latter is recognized as
a valid column. Note that because
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math>
is categorical, we also specified the <code>parents</code> argument here
just to be safe.</p>
</div>
<div class="section level2">
<h2 id="using-cubic-terms">Using Cubic Terms<a class="anchor" aria-label="anchor" href="#using-cubic-terms"></a>
</h2>
<p>Sometimes we also want to include non-linear relationships between a
continuous variable and the outcome in a data generation process. This
can be done by including cubic terms of that variable in a formula.
Suppose the regression model that we want to use has the following
form:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mo>∼</mo><mo>−</mo><mn>8</mn><mo>+</mo><mi>A</mi><mo>⋅</mo><mn>0.4</mn><mo>+</mo><msup><mi>A</mi><mn>2</mn></msup><mo>⋅</mo><mn>0.02</mn><mo>+</mo><mi>B</mi><mo>⋅</mo><mo>−</mo><mn>2</mn><mo>+</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1.5</mn><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex">D \sim -8 + A \cdot 0.4 + A^2 \cdot 0.02 + B \cdot -2 + N(0, 1.5).</annotation></semantics></math></p>
<p>The following code may be used to define such as node:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dag_with_formula</span> <span class="op">&lt;-</span> <span class="va">dag</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="st">"D"</span>, type<span class="op">=</span><span class="st">"gaussian"</span>, formula<span class="op">=</span> <span class="op">~</span> <span class="op">-</span><span class="fl">8</span> <span class="op">+</span> <span class="va">A</span><span class="op">*</span><span class="fl">0.4</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">A</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="fl">0.02</span> <span class="op">+</span> <span class="va">B</span><span class="op">*</span><span class="op">-</span><span class="fl">2</span>,</span>
<span>       error<span class="op">=</span><span class="fl">1.5</span><span class="op">)</span></span></code></pre></div>
<p>Users may of course use as many cubic terms as they like.</p>
</div>
<div class="section level2">
<h2 id="using-functions-in-formula">Using Functions in formula<a class="anchor" aria-label="anchor" href="#using-functions-in-formula"></a>
</h2>
<p>There is also direct support for including functions in the formula
as well. For example, it is allowed to call any function on the beta
coefficients, which is useful to specify betas on a different scale (for
example using Odds-Ratios instead of betas). For example:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dag_with_fun</span> <span class="op">&lt;-</span> <span class="va">dag</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="st">"D"</span>, type<span class="op">=</span><span class="st">"binomial"</span>, formula<span class="op">=</span> <span class="op">~</span> <span class="op">-</span><span class="fl">3</span> <span class="op">+</span> <span class="va">A</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> <span class="va">B</span><span class="op">*</span><span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p>is valid syntax. Any function can be used in the place of
<code><a href="https://rdrr.io/r/base/Log.html" class="external-link">log()</a></code>, as long as it is a single function that is called on
a beta-coefficient. It is also possible to use functions on the
variables themselves. However, it is required to wrap them in a
<code><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I()</a></code> call. For example, using something like
<code>~ -3 + log(A)*0.5 + B*0.2</code> would not work, but
<code>~ -3 + I(log(A))*0.5 + B*0.2</code> is valid syntax. Although
supported in most cases, we strongly advise against using function names
with special characters. These might lead to weird errors when random
effects or random slopes are also contained in the
<code>formula</code>.</p>
</div>
<div class="section level2">
<h2 id="using-special-characters-in-formula">Using Special Characters in formula<a class="anchor" aria-label="anchor" href="#using-special-characters-in-formula"></a>
</h2>
<p>Although not recommended, it is possible to use variable names
containing special characters in <code>formula</code>, by escaping them
using the usual R syntax. For example, if the user wanted to use
<code>this-var</code> as a variable name and use that variable as a
parent node in a <code>formula</code>, this could be done using the
following code:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dag_with_fun</span> <span class="op">&lt;-</span> <span class="va">dag</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="st">"this-var"</span>, type<span class="op">=</span><span class="st">"binomial"</span>, formula<span class="op">=</span> <span class="op">~</span> <span class="op">-</span><span class="fl">3</span> <span class="op">+</span> <span class="va">A</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> <span class="va">B</span><span class="op">*</span><span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="st">"D"</span>, type<span class="op">=</span><span class="st">"binomial"</span>, formula<span class="op">=</span> <span class="op">~</span> <span class="fl">5</span> <span class="op">+</span> <span class="va">`this-var`</span><span class="op">*</span><span class="fl">0.3</span><span class="op">)</span></span></code></pre></div>
<p>There are, however, six special characters that may not be used in
<code>formula</code>: spaces, <code>+</code>, <code>*</code>,
<code>(</code>, <code>)</code> and <code>|</code>. Errors may be
produced when using these characters in variable names, because they are
used internally to figure out which variables belong together and how
(the latter three mostly for mixed model syntax). It is best to avoid
special characters though, just to be safe.</p>
</div>
<div class="section level2">
<h2 id="using-random-effects-and-random-slopes">Using Random Effects and Random Slopes<a class="anchor" aria-label="anchor" href="#using-random-effects-and-random-slopes"></a>
</h2>
<p>Currently, three node types (<code>"gaussian"</code>,
<code>"binomial"</code> and <code>"poisson"</code>) directly allow the
user to specify random effects and random slopes in the
<code>formula</code>. These should be specified exactly as they would be
in a regular call to the <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer()</a></code> function. For example,
consider the following <code>DAG</code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dag_mixed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/empty_dag.html">empty_dag</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="st">"School"</span>, type<span class="op">=</span><span class="st">"rcategorical"</span>, probs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>       labels<span class="op">=</span><span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="st">"Age"</span>, type<span class="op">=</span><span class="st">"rnorm"</span>, mean<span class="op">=</span><span class="fl">12</span>, sd<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="st">"Grade"</span>, type<span class="op">=</span><span class="st">"gaussian"</span>, formula<span class="op">=</span> <span class="op">~</span> <span class="op">-</span><span class="fl">2</span> <span class="op">+</span> <span class="va">Age</span><span class="op">*</span><span class="fl">1.2</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">School</span><span class="op">)</span>,</span>
<span>       error<span class="op">=</span><span class="fl">1</span>, var_corr<span class="op">=</span><span class="fl">0.3</span><span class="op">)</span></span></code></pre></div>
<p>Here, we have a <code>School</code> variable in which students of
different <code>Age</code>s are nested. To simulate the
<code>Grade</code> of each student, we want to use a random intercept
per <code>School</code>, so we simply add the classic
<code>(1|School)</code> term to the <code>formula</code>. Whenever this
is done, the <code>var_corr</code> argument also has to be specified,
which allows users to control the standard deviation of the random
effects. Internally, the <code><a href="https://rdrr.io/pkg/simr/man/makeGlmer.html" class="external-link">makeLmer()</a></code> and
<code><a href="https://rdrr.io/pkg/simr/man/doSim.html" class="external-link">doSim()</a></code> functions form the <code>simr</code> package are
used to simulate these types of nodes. Please consult the documentation
of that package for details on how to specify more complex mixed model
structures, for example using multiple correlated random effects.</p>
<p>In principle, arbitrary amounts of random effects can be added.
Random slopes can similarly be defined using the standard syntax. In the
following <code>DAG</code>, we use a random slope for <code>Age</code>
per <code>School</code> in addition to the random effect of
<code>School</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">var_corr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dag_mixed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/empty_dag.html">empty_dag</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="st">"School"</span>, type<span class="op">=</span><span class="st">"rcategorical"</span>, probs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>       labels<span class="op">=</span><span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="st">"Age"</span>, type<span class="op">=</span><span class="st">"rnorm"</span>, mean<span class="op">=</span><span class="fl">12</span>, sd<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="st">"Grade"</span>, type<span class="op">=</span><span class="st">"gaussian"</span>, formula<span class="op">=</span> <span class="op">~</span> <span class="op">-</span><span class="fl">2</span> <span class="op">+</span> <span class="va">Age</span><span class="op">*</span><span class="fl">1.2</span> <span class="op">+</span> <span class="op">(</span><span class="va">Age</span><span class="op">|</span><span class="va">School</span><span class="op">)</span>,</span>
<span>       error<span class="op">=</span><span class="fl">1</span>, var_corr<span class="op">=</span><span class="va">var_corr</span><span class="op">)</span></span></code></pre></div>
<p>Note that in this example, we defined the correlation between the
random effect and slopes using arbitrarily picked numbers using the
<code>var_corr</code> argument. Because of the much more complex DGP and
the computational overhead required to re-structure the data internally,
simulations including mixed model syntax is usually much slower than
simulations without them. In small samples this is not an issue, but
very large values for <code>n_sim</code> or using these specifications
in discrete-time simulations with large <code>max_t</code> may be
difficult in some cases.</p>
</div>
<div class="section level2">
<h2 id="using-external-coefficients-advanced-usage">Using External Coefficients (Advanced Usage)<a class="anchor" aria-label="anchor" href="#using-external-coefficients-advanced-usage"></a>
</h2>
<p>Sometimes it may be useful to define the causal coefficients in
external variables, for example when writing a function that creates a
<code>DAG</code> objects with some set coefficients. This is supported
through the use of the <code><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval()</a></code> function as well. For
example:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">beta_coef</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dag_with_external</span> <span class="op">&lt;-</span> <span class="va">dag</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="st">"D"</span>, type<span class="op">=</span><span class="st">"binomial"</span>, formula<span class="op">=</span> <span class="op">~</span> <span class="op">-</span><span class="fl">3</span> <span class="op">+</span> <span class="va">A</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="va">beta_coef</span><span class="op">)</span> <span class="op">+</span> <span class="va">B</span><span class="op">*</span><span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p>is valid syntax. Note that this only works if the variable wrapped in
the <code><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval()</a></code> function call is defined in the same environment
in which the <code>DAG</code> object is being created. If this is not
the case, some weird error messages may be produced, depending on the
code used. Another option is to put the formula together as a string
before passing it to <code><a href="../reference/node.html">node()</a></code> like this:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">beta_coef</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">form_D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"~ -3 + A*"</span>, <span class="va">beta_coef</span>, <span class="st">"+ B*0.2"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dag_with_external</span> <span class="op">&lt;-</span> <span class="va">dag</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="st">"D"</span>, type<span class="op">=</span><span class="st">"binomial"</span>, formula<span class="op">=</span><span class="va">form_D</span><span class="op">)</span></span></code></pre></div>
<p>Since <code>formula</code> may always also be passed as a single
string, this is perfectly valid syntax and might allow users even more
flexibility when creating formulas inside functions.</p>
</div>
<div class="section level2">
<h2 id="using-formulas-in-custom-node-types-advanced-usage">Using Formulas in Custom Node Types (Advanced Usage)<a class="anchor" aria-label="anchor" href="#using-formulas-in-custom-node-types-advanced-usage"></a>
</h2>
<p>One of the great things about this package is that users can supply
<em>any</em> function to the <code>type</code> argument of
<code><a href="../reference/node.html">node()</a></code> and <code><a href="../reference/node.html">node_td()</a></code>, as long as it fulfills
some minimal requirements (as described in <code>?node_custom</code>).
Whenever such a function is supplied, users may still use the enhanced
<code>formula</code> interface!</p>
<p>Internally, whenever an enhanced <code>formula</code> is supplied to
<code><a href="../reference/node.html">node()</a></code> or <code><a href="../reference/node.html">node_td()</a></code>, the formula is parsed to
extract all variable names and beta-coefficients. If cubic terms,
interactions or levels of categorical parent nodes are included in
<code>formula</code>, the data will be re-structured in a way that it
includes a single column for each term in <code>formula</code>. Consider
the following example:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">custom_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">parents</span>, <span class="va">betas</span>, <span class="va">intercept</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">parents</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">betas</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">intercept</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">dag_custom</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/empty_dag.html">empty_dag</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>, type<span class="op">=</span><span class="st">"rnorm"</span>, mean<span class="op">=</span><span class="fl">0</span>, sd<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="st">"C"</span>, type<span class="op">=</span><span class="st">"rcategorical"</span>, probs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>, labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lev1"</span>, <span class="st">"lev2"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Here, we defined a custom function for a node called
<code>custom_fun</code>, which really only returns 1, regardless of the
input. However, it also prints the first few lines of the input
<code>data</code>, the <code>parents</code>, the <code>betas</code> and
the <code>intercept</code> it is passed, so that we can see whats going
on under the hood. Next, we defined some arbitrary <code>DAG</code>
containing two numerical root nodes and a binary root node. Here is what
happens if we use <code>custom_fun</code> with a <code>formula</code>
input:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dag_custom2</span> <span class="op">&lt;-</span> <span class="va">dag_custom</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="st">"Y"</span>, type<span class="op">=</span><span class="va">custom_fun</span>, formula<span class="op">=</span> <span class="op">~</span> <span class="op">-</span><span class="fl">5</span> <span class="op">+</span> <span class="va">A</span><span class="op">*</span><span class="fl">2</span> <span class="op">+</span> <span class="va">B</span><span class="op">*</span><span class="op">-</span><span class="fl">0.4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_from_DAG.html">sim_from_dag</a></span><span class="op">(</span><span class="va">dag_custom2</span>, n_sim<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt;              A          B</span></span>
<span><span class="co">#&gt;          &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: -0.56047565  1.2240818</span></span>
<span><span class="co">#&gt; 2: -0.23017749  0.3598138</span></span>
<span><span class="co">#&gt; 3:  1.55870831  0.4007715</span></span>
<span><span class="co">#&gt; 4:  0.07050839  0.1106827</span></span>
<span><span class="co">#&gt; 5:  0.12928774 -0.5558411</span></span>
<span><span class="co">#&gt; 6:  1.71506499  1.7869131</span></span>
<span><span class="co">#&gt; [1] "A" "B"</span></span>
<span><span class="co">#&gt; [1]  2.0 -0.4</span></span>
<span><span class="co">#&gt; [1] -5</span></span></code></pre></div>
<p>We can see that it simply took the <code>data</code> that was
required and printed it. Note that in the <code><a href="../reference/node.html">node()</a></code>
definition, we did not need to specify the <code>parents</code>,
<code>betas</code> or <code>intercept</code> arguments of the custom
node, all we had to do was pass it the enhanced <code>formula</code> and
it happily extracted this information from it and passed it to
<code>custom_fun</code> directly. The only requirement for this to work
is that <code>custom_fun</code> does have these arguments. Now lets see
what happens with special terms in <code>formula</code>:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dag_custom2</span> <span class="op">&lt;-</span> <span class="va">dag_custom</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="st">"Y"</span>, type<span class="op">=</span><span class="va">custom_fun</span>, formula<span class="op">=</span> <span class="op">~</span> <span class="op">-</span><span class="fl">5</span> <span class="op">+</span> <span class="va">A</span><span class="op">*</span><span class="fl">2</span> <span class="op">+</span> <span class="va">B</span><span class="op">*</span><span class="op">-</span><span class="fl">0.4</span> <span class="op">+</span> <span class="va">A</span><span class="op">:</span><span class="va">B</span><span class="op">*</span><span class="fl">0.1</span> <span class="op">+</span> </span>
<span>         <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">A</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="op">-</span><span class="fl">0.1</span> <span class="op">+</span> <span class="va">Clev2</span><span class="op">*</span><span class="fl">0.2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_from_DAG.html">sim_from_dag</a></span><span class="op">(</span><span class="va">dag_custom2</span>, n_sim<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt;             A          B         A:B     I(A^2) Clev2</span></span>
<span><span class="co">#&gt;         &lt;num&gt;      &lt;num&gt;       &lt;num&gt;      &lt;num&gt; &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:  0.4264642 -0.6947070 -0.29626767 0.18187173     0</span></span>
<span><span class="co">#&gt; 2: -0.2950715 -0.2079173  0.06135046 0.08706718     1</span></span>
<span><span class="co">#&gt; 3:  0.8951257 -1.2653964 -1.13268875 0.80124995     1</span></span>
<span><span class="co">#&gt; 4:  0.8781335  2.1689560  1.90463287 0.77111842     0</span></span>
<span><span class="co">#&gt; 5:  0.8215811  1.2079620  0.99243873 0.67499547     0</span></span>
<span><span class="co">#&gt; 6:  0.6886403 -1.1231086 -0.77341778 0.47422540     1</span></span>
<span><span class="co">#&gt; [1] "A"      "B"      "A:B"    "I(A^2)" "Clev2" </span></span>
<span><span class="co">#&gt; [1]  2.0 -0.4  0.1 -0.1  0.2</span></span>
<span><span class="co">#&gt; [1] -5</span></span></code></pre></div>
<p>Now we can see a slightly different picture. Instead of simply
returning the relevant parts of <code>data</code>, the function has
re-structured it in a way similar to the <code><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix()</a></code>
function, allowing us to directly apply the <code>betas</code> to it.
Note that the <code>betas</code> will always be in the right order,
meaning that the first entry in <code>betas</code> corresponds to the
first term named in <code>parents</code>. The following code is an
example how one could re-build a linear regression using this
interface:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">custom_linreg</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">parents</span>, <span class="va">betas</span>, <span class="va">intercept</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">intercept</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span><span class="st">"*"</span>, <span class="va">data</span>, <span class="va">betas</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, mean<span class="op">=</span><span class="fl">0</span>, sd<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">dag_custom3</span> <span class="op">&lt;-</span> <span class="va">dag_custom</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="st">"Y"</span>, type<span class="op">=</span><span class="va">custom_linreg</span>, formula<span class="op">=</span> <span class="op">~</span> <span class="op">-</span><span class="fl">5</span> <span class="op">+</span> <span class="va">A</span><span class="op">*</span><span class="fl">2</span> <span class="op">+</span> <span class="va">B</span><span class="op">*</span><span class="op">-</span><span class="fl">0.4</span> <span class="op">+</span> <span class="va">A</span><span class="op">:</span><span class="va">B</span><span class="op">*</span><span class="fl">0.1</span> <span class="op">+</span> </span>
<span>         <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">A</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="op">-</span><span class="fl">0.1</span> <span class="op">+</span> <span class="va">Clev2</span><span class="op">*</span><span class="fl">0.2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_from_DAG.html">sim_from_dag</a></span><span class="op">(</span><span class="va">dag_custom3</span>, n_sim<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt;             A          B      C         Y</span></span>
<span><span class="co">#&gt;         &lt;num&gt;      &lt;num&gt; &lt;char&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:  0.3796395  1.0527115   lev1 -4.841552</span></span>
<span><span class="co">#&gt; 2: -0.5023235 -1.0491770   lev1 -4.906313</span></span>
<span><span class="co">#&gt; 3: -0.3332074 -1.2601552   lev1 -4.857700</span></span>
<span><span class="co">#&gt; 4: -1.0185754  3.2410399   lev2 -7.542767</span></span>
<span><span class="co">#&gt; 5: -1.0717912 -0.4168576   lev2 -6.029375</span></span>
<span><span class="co">#&gt; 6:  0.3035286  0.2982276   lev2 -4.522188</span></span></code></pre></div>
<p>Here, we simply calculate the linear predictor using the sum of the
rows after multiplying each value with the corresponding
<code>betas</code> coefficient and add a normally distributed error term
with standard deviation of 1 afterwards. Of course users can use this
type of strategy for much more complex node types. Note that the
intercept is not required to be there. By omitting it from the supplied
function, it will automatically no longer be required in
<code>formula</code> (and will be ignored if still specified):</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># same as before, but without an intercept (same as setting intercept=0)</span></span>
<span><span class="va">custom_linreg2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">parents</span>, <span class="va">betas</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span><span class="st">"*"</span>, <span class="va">data</span>, <span class="va">betas</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, mean<span class="op">=</span><span class="fl">0</span>, sd<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">dag_custom4</span> <span class="op">&lt;-</span> <span class="va">dag_custom</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/node.html">node</a></span><span class="op">(</span><span class="st">"Y"</span>, type<span class="op">=</span><span class="va">custom_linreg2</span>, formula<span class="op">=</span> <span class="op">~</span> <span class="va">A</span><span class="op">*</span><span class="fl">2</span> <span class="op">+</span> <span class="va">B</span><span class="op">*</span><span class="op">-</span><span class="fl">0.4</span> <span class="op">+</span> <span class="va">A</span><span class="op">:</span><span class="va">B</span><span class="op">*</span><span class="fl">0.1</span> <span class="op">+</span> </span>
<span>         <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">A</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="op">-</span><span class="fl">0.1</span> <span class="op">+</span> <span class="va">Clev2</span><span class="op">*</span><span class="fl">0.2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_from_DAG.html">sim_from_dag</a></span><span class="op">(</span><span class="va">dag_custom4</span>, n_sim<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt;             A          B      C          Y</span></span>
<span><span class="co">#&gt;         &lt;num&gt;      &lt;num&gt; &lt;char&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:  0.8719650 -0.8338436   lev1  2.4685174</span></span>
<span><span class="co">#&gt; 2: -0.3484724  0.5787224   lev1 -0.3442883</span></span>
<span><span class="co">#&gt; 3:  0.5185038 -1.0875807   lev2  2.2053315</span></span>
<span><span class="co">#&gt; 4: -0.3906850  1.4840309   lev1 -3.1403262</span></span>
<span><span class="co">#&gt; 5: -1.0927872 -1.1862066   lev2 -1.1321410</span></span>
<span><span class="co">#&gt; 6:  1.2100105  0.1010792   lev2  3.4132667</span></span></code></pre></div>
<p>Note that if you passed the <code>custom_linreg</code> function to
the <code><a href="../reference/node.html">node()</a></code> call above instead, you would receive an error
message because of the missing intercept. All of this of course also
works with time-dependent nodes specified using <code><a href="../reference/node.html">node_td()</a></code>
calls.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Robin Denz, Katharina Meiszl.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
